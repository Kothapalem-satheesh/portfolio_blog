{% extends "base.html" %}
{% block title %}{{ post.title }} â€“ Blog{% endblock %}
{% block content %}

{# Reading progress bar #}
<div id="reading-progress"></div>

<article class="section container narrow reveal" id="post-body">

  {# Cover image #}
  {% if post.cover_image %}
    <div class="post-cover">
      <img src="{{ post.cover_image.url }}" alt="{{ post.title }}" />
    </div>
  {% endif %}

  {# Post header #}
  <div class="section-head" style="margin-top:{% if post.cover_image %}24px{% else %}0{% endif %};">
    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
      <span class="section-label">Blog</span>
      {% if post.status == 'draft' %}
        <span class="status-badge draft">Draft</span>
      {% endif %}
      {% if post.category %}
        <span class="tech-tag">{{ post.category.name }}</span>
      {% endif %}
    </div>
    <h1>{{ post.title }}</h1>
  </div>

  {# Meta bar: date Â· author Â· reading time #}
  <div class="post-meta-bar">
    <span>ğŸ“… {{ post.published_at|date:"F d, Y"|default:"Unpublished" }}</span>
    <span class="dot">Â·</span>
    <span>âœï¸ {{ post.author.get_full_name|default:post.author.username }}</span>
    {% if post.category %}
      <span class="dot">Â·</span>
      <span>ğŸ“ {{ post.category.name }}</span>
    {% endif %}
    <span class="dot">Â·</span>
    <span id="reading-time" class="read-time">â± Calculatingâ€¦</span>
  </div>

  {# Staff actions #}
  {% if user.is_staff %}
    <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
      <a class="btn btn-secondary" href="{% url 'blog_edit' post.slug %}" style="font-size:.85rem; padding:7px 14px;">âœï¸ Edit Post</a>
      <a class="btn btn-secondary" href="{% url 'blog_delete' post.slug %}" style="font-size:.85rem; padding:7px 14px; border-color:#ef4444; color:#ef4444;">ğŸ—‘ Delete</a>
      <a class="btn btn-secondary" href="{% url 'dashboard' %}" style="font-size:.85rem; padding:7px 14px;">â† Dashboard</a>
    </div>
  {% endif %}

  {# Tags #}
  {% if post.tags %}
    <div class="post-tags">
      {% for tag in post.tags.split %}
        <span class="tech-tag">{{ tag|cut:"," }}</span>
      {% endfor %}
    </div>
  {% endif %}

  {# Content #}
  <div class="richtext form-card" style="margin-bottom:8px;">
    {{ post.content|linebreaks }}
  </div>

  {# Share buttons #}
  <div class="share-bar">
    <span>Share:</span>
    <a class="share-btn"
       href="https://twitter.com/intent/tweet?text={{ post.title|urlencode }}&url={{ request.build_absolute_uri }}"
       target="_blank" rel="noreferrer">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.748l7.74-8.851L2.04 2.25h6.992l4.265 5.632L18.244 2.25zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
      X / Twitter
    </a>
    <a class="share-btn"
       href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri|urlencode }}"
       target="_blank" rel="noreferrer">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
      LinkedIn
    </a>
    <button class="share-btn copy-btn" id="copy-link-btn" onclick="copyLink(this)">
      ğŸ”— Copy Link
    </button>
  </div>

  {# Post navigation back #}
  <div class="post-nav">
    <a href="{% url 'blog_list' %}">â† Back to Blog</a>
    <a href="{% url 'home' %}">Home</a>
  </div>

</article>

{# â”€â”€ Pending comments (staff only) â”€â”€ #}
{% if user.is_staff and pending_comments %}
  <section class="section container narrow reveal">
    <div class="section-head">
      <h2>Pending Moderation</h2>
      <p>{{ pending_comments|length }} comment{{ pending_comments|length|pluralize }} awaiting approval.</p>
    </div>
    {% for c in pending_comments %}
      <div class="comment" style="border-left: 3px solid #f59e0b; margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px; margin-bottom:8px;">
          <strong>{{ c.author.username }}</strong>
          <div style="display:flex; gap:8px;">
            <form method="post" action="{% url 'comment_approve' c.pk %}">{% csrf_token %}
              <button class="dash-btn" type="submit">âœ“ Approve</button>
            </form>
            <form method="post" action="{% url 'comment_delete' c.pk %}">{% csrf_token %}
              <input type="hidden" name="next" value="{{ post.get_absolute_url }}" />
              <button class="dash-btn danger" type="submit">âœ• Delete</button>
            </form>
          </div>
        </div>
        <p>{{ c.body }}</p>
        <small>{{ c.created_at|date:"M d, Y H:i" }}</small>
      </div>
    {% endfor %}
  </section>
{% endif %}

{# â”€â”€ Approved comments â”€â”€ #}
<section class="section container narrow reveal">
  <div class="section-head">
    <h2>Discussion</h2>
    <p>
      {{ comments|length }} comment{{ comments|length|pluralize }}
      {% if not user.is_authenticated %} â€” <a href="{% url 'login' %}">sign in to comment</a>{% endif %}
    </p>
  </div>

  {% if user.is_authenticated %}
    <form method="post" action="{% url 'comment_create' post.slug %}" class="form-card" style="margin-bottom:24px;">
      {% csrf_token %}
      {{ comment_form.as_p }}
      <button class="btn" type="submit" style="margin-top:8px;">Post Comment</button>
    </form>
  {% endif %}

  {% for comment in comments %}
    <article class="comment reveal" style="margin-bottom:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:6px; margin-bottom:6px;">
        <div style="display:flex; align-items:center; gap:8px;">
          <span style="width:32px; height:32px; border-radius:50%; background:linear-gradient(135deg,var(--brand),var(--brand-2)); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:.85rem; color:#fff; flex-shrink:0;">
            {{ comment.author.username|first|upper }}
          </span>
          <strong>{{ comment.author.username }}</strong>
        </div>
        {% if user.is_staff %}
          <form method="post" action="{% url 'comment_delete' comment.pk %}">{% csrf_token %}
            <input type="hidden" name="next" value="{{ post.get_absolute_url }}" />
            <button class="dash-btn danger" type="submit" style="font-size:.75rem; padding:3px 9px;">Delete</button>
          </form>
        {% endif %}
      </div>
      <p style="margin-left:40px;">{{ comment.body }}</p>
      <small style="margin-left:40px;">{{ comment.created_at|date:"M d, Y H:i" }}</small>
    </article>
  {% empty %}
    <div class="card" style="text-align:center; padding:32px;">
      <p>No comments yet. Be the first to share your thoughts!</p>
    </div>
  {% endfor %}
</section>

<script>
/* Reading progress */
(function(){
  const bar  = document.getElementById("reading-progress");
  const body = document.getElementById("post-body");
  if (!bar || !body) return;
  window.addEventListener("scroll", () => {
    const rect  = body.getBoundingClientRect();
    const total = body.offsetHeight - window.innerHeight;
    const pct   = Math.min(100, Math.max(0, (-rect.top / total) * 100));
    bar.style.width = pct + "%";
  }, { passive: true });
})();

/* Reading time estimate */
(function(){
  const el = document.getElementById("reading-time");
  const content = document.querySelector(".richtext");
  if (!el || !content) return;
  const words = content.innerText.trim().split(/\s+/).length;
  const mins  = Math.max(1, Math.round(words / 200));
  el.textContent = `â± ${mins} min read`;
})();

/* Copy link */
function copyLink(btn) {
  navigator.clipboard.writeText(window.location.href).then(() => {
    btn.textContent = "âœ“ Copied!";
    setTimeout(() => { btn.textContent = "ğŸ”— Copy Link"; }, 2000);
  });
}
</script>
{% endblock %}
